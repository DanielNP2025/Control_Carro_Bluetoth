<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carro Competencia</title>

<style>
body{
  margin:0;
  font-family:Arial;
  text-align:center;
  background: radial-gradient(circle at center, #111 0%, #000 90%);
  color:white;
}

h1{
  margin-top:20px;
  text-shadow:0 0 20px cyan;
}

button{
  padding:15px 25px;
  font-size:18px;
  margin:10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
}

#connect{
  background:#00ff99;
  box-shadow:0 0 20px #00ff99;
}

#status{
  margin-top:10px;
  font-size:18px;
}

#joystick{
  width:260px;
  height:260px;
  background:#111;
  border-radius:50%;
  margin:30px auto;
  position:relative;
  box-shadow:0 0 40px cyan inset, 0 0 25px cyan;
}

#stick{
  width:90px;
  height:90px;
  background:cyan;
  border-radius:50%;
  position:absolute;
  top:85px;
  left:85px;
  box-shadow:0 0 30px cyan;
}
</style>
</head>

<body>

<h1>üèÅ CARRO NIVEL COMPETENCIA</h1>

<button id="connect">üîó Conectar</button>
<div id="status">Desconectado</div>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>
let device, characteristic;

const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
const CHAR_UUID = "abcdefab-1234-1234-1234-abcdefabcdef";

document.getElementById("connect").onclick = async () => {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ name: "CarroESP32" }],
    optionalServices: [SERVICE_UUID]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  characteristic = await service.getCharacteristic(CHAR_UUID);

  document.getElementById("status").innerHTML = "üü¢ Conectado";
  document.getElementById("status").style.color = "#00ff99";
};

function sendMotor(left, right){
  if(!characteristic) return;

  let encoder = new TextEncoder();
  let comando = `M,${parseInt(left)},${parseInt(right)}`;
  characteristic.writeValue(encoder.encode(comando));
}

let stick = document.getElementById("stick");
let joystick = document.getElementById("joystick");

joystick.addEventListener("touchmove", function(e){
  e.preventDefault();

  let rect = joystick.getBoundingClientRect();
  let x = e.touches[0].clientX - rect.left - 130;
  let y = e.touches[0].clientY - rect.top - 130;

  let max = 110;
  x = Math.max(-max, Math.min(max, x));
  y = Math.max(-max, Math.min(max, y));

  stick.style.left = (x + 130 - 45) + "px";
  stick.style.top = (y + 130 - 45) + "px";

  let forward = -y * 2;
  let turn = x * 2;

  let leftMotor = forward + turn;
  let rightMotor = forward - turn;

  leftMotor = Math.max(-255, Math.min(255, leftMotor));
  rightMotor = Math.max(-255, Math.min(255, rightMotor));

  sendMotor(leftMotor, rightMotor);
});

joystick.addEventListener("touchend", function(){
  stick.style.left = "85px";
  stick.style.top = "85px";
  sendMotor(0,0);
});
</script>

</body>
</html>
